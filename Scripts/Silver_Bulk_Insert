-- check for NULLS and DUPLICATE in Primary Key--
---- DATA CLENSING STARTED -----
--------------------------------
--- Going Through cst_id One by Once to correct them
SELECT * FROM bronze.crm_cust_info
WHERE cst_id IN (29466);
-- 29473,29449,29433,29483--

-------- Used Transaction to be safe when deleting
BEGIN;
DELETE FROM bronze.crm_cust_info
WHERE cst_create_date IN ( '2026-01-26','2026-01-25')
--WHERE cst_create_date = '2026-01-26' OR cst_create_date ='2026-01-25' 
--This will delete:
-- All rows with cst_create_date = '2026-01-26' (no matter the ID)
--AND rows where:
AND cst_id = 29466
AND cst_id IN (29466)
ROLLBACK;
COMMIT;

------ Using WINDOW FUNCTION to DELETE like above

------ Using WINDOW FUNCTION to DELETE like above

BEGIN;
WITH Latest_entry AS
		
		(SELECT cst_create_date,cst_id, RANK() OVER(Partition BY cst_id ORDER BY cst_create_date DESC) AS Rank_, ROW_NUMBER() OVER(partition BY cst_id ORDER BY cst_create_date DESC) AS ROW_NUMBER_
		FROM bronze.crm_cust_info
		WHERE cst_id IN (29473,29449,29433,29483))


--BEGIN; this cant be here CTE must follow the below
DELETE FROM bronze.crm_cust_info
WHERE (cst_create_date,cst_id) IN 
	(SELECT cst_create_date,cst_id
	FROM Latest_entry
	WHERE Rank_ >1)


SELECT * FROM bronze.crm_cust_info
WHERE cst_id IN (29466,29473,29449,29433,29483);
-- 29473,29449,29433,29483
COMMIT;
----- STEP 2 STRING fixing if we have any inconsistencies
SELECT * FROM bronze.crm_cust_info
SELECT DISTINCT(cst_gndr) FROM bronze.crm_cust_info;
SELECT DISTINCT(cst_marital_status) FROM bronze.crm_cust_info;
---- Expectation - to have no spaces begining or at the end and consistent naming format for all strings
SELECT cst_id,cst_key,
--cst_firstname & Lastname
TRIM(cst_firstname) AS cst_firstname,
TRIM(cst_lastname) AS cst_lastname,
---cst_marital_status- we dont want to use short forms - Data Normalisation or data standardisation-- transforming coded language to userfriendly
CASE WHEN TRIM(UPPER(cst_gndr)) = 'M' THEN 'Male'
	WHEN  TRIM(UPPER(cst_gndr)) = 'F' THEN 'Female'
	ELSE 'n/a' 
	END AS cst_gndr,
CASE WHEN TRIM(UPPER (cst_marital_status)) = 'M' THEN 'Married'
	WHEN TRIM(UPPER (cst_marital_status)) = 'S' THEN 'Single'
	ELSE 'n/a'
	END AS cst_marital_status,
cst_create_date
FROM bronze.crm_cust_info
